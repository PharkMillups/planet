{
  "enclosures": [],
  "title": "Webmachine, ErlyDTL and Riak - Part 3",
  "link": "http://buffered.io/2010/10/13/webmachine-erlydtl-and-riak-part-3/",
  "pubdate": "2010-10-13T11:31:58.000Z",
  "rfc822": "Wed, 13 Oct 2010 04:31:58 -0700",
  "category": "Databases",
  "guid": "http://buffered.io/2010/10/13/webmachine-erlydtl-and-riak-part-3/",
  "description": "<style>\nspan.filename\n{\n  font-weight: bold;\n  font-family: Consolas, Courier;\n  font-size: 12px;\n  text-align: right;\n  display: block;\n  margin: 0;\n  padding: 3px;\n  background-color: #e0e0ff;\n}\n</style>\n\n<p><img src=\"http://buffered.io/uploads/2010/09/riak-logo.png\" alt=\"Riak Logo\" style=\"float:left;padding-right:5px;padding-bottom:5px;\"/>For those of you who are new to the series, you may want to check out <a href=\"http://buffered.io/2010/09/01/webmachine-erlydtl-and-riak-part-1/\" title=\"Wembachine, ErlyDTL and Riak - Part 1\">Part 1</a> and <a href=\"http://buffered.io/2010/09/12/webmachine-erlydtl-and-riak-part-2/\" title=\"Wembachine, ErlyDTL and Riak - Part 2\">Part 2</a> before reading this post. It will help give you some context as well as introduce you to some of the jargon and technology that I'm using. If you've already read then, or don't want to, then please read on!</p>\n<p>This post builds on the previous two, but not without a few little modifications. If you're interested in following along step by step with your own version of the code running, then get yourself a copy of <a href=\"https://bitbucket.org/OJ/csd/changeset/df62880d12a8\" title=\"Source code for Part 2\">this changeset</a> before doing so.</p>\n<p>In this post we're going to cover:</p>\n<ol>\n<li>A slight refactor of code structure to support the \"standard\" approach to building applications in Erlang using OTP.</li>\n<li>Building a small set of modules to talk to <a href=\"http://www.basho.com/developers.html#Riak\" title=\"Riak\">Riak</a>.</li>\n<li>Creation of some <a href=\"http://json.org/\" title=\"JavaScript Object Notation\">JSON</a> helper functions for reading and writing data.</li>\n<li>Calling all the way from the <a href=\"http://www.basho.com/developers.html#Webmachine\" title=\"Webmachine\">Webmachine</a> front-end to Riak to extract data and display it in a browser using <a href=\"http://github.com/evanmiller/erlydtl\" title=\"ErlyDTL\">ErlyDTL</a> templates.</li>\n</ol>\n<p>There are quite a few code snippets in this post as well as output from script executions and <code>bash</code> sessions. To avoid confusion, all file listings reference the path to the file that is being modified relative to the root of the project folder.</p>\n<p>Be warned, this is a <em>long</em> post :) Get yourself a <em>shmoke und a pancake</em>, a glass of your favourite beverage and put some relaxing music on (instrumental is best).</p>\n<p>Are you ready? OK, here we go ... <!--more--></p>\n<h2>A Slight Refactor</h2>\n<p>I was ready to embark on this third post a while back but then I sat back and thought about how I might structure things if I were using another set of technologies. Usually I would put another layer between the web tier and the back-end database cluster as opposed to having the web tier talk to the database directly. It didn't make sense to me that this approach would be any different in Erlang.</p>\n<p>I had a chat to <a href=\"http://twitter.com/sj_mackenzie\" title=\"Stewart Mackenzie on Twitter\">two</a> <a href=\"http://twitter.com/MatthewErbs\" title=\"Matt Erbs on Twitter\">blokes</a> that I really respect to get their views, and then I fired off a question to the Basho guys (via the <a href=\"irc://irc.freenode.com/riak\" title=\"Riak IRC on Freenode\">#riak IRC channel</a>). The Basho lads even made the effort to respond to me via the <a href=\"http://lists.basho.com/pipermail/riak-users_lists.basho.com/2010-September/001984.html\" title=\"Riak Recap\">Riak Recap</a> as they weren't available at the time to answer me via IRC (thanks again <a href=\"http://twitter.com/pharkmillups\" title=\"Mark Phillips on Twitter\">Mark</a>). All three of them confirmed my thoughts. Here's what appeared in the recap which captures the question and response nicely:</p>\n<blockquote>\n<p>Q --- I have a Webmachine application which will be talking to Riak. I was going to put application and controller logic in that application and I am wondering if [I] should instead be creating a \"core\" OTP application with the business style logic in it and have the Webmachine app talk to that app which, in turn, talks to Riak? Is that the general approach that is taken [in Erlang applications]? (from TheColonial via #riak)</p>\n<p>A --- We recommend going with the latter approach. You're better off to create a core app that talks to Webmachine and Riak separately.</p>\n</blockquote>\n<p>Perfect, that makes total sense. Therefore the following describes what I did to modify the code base that I had in order to support this set up. <strong>Any failure</strong> in implementation, structure or understanding is totally my own and in no way reflects on the abilities and advice of those mentioned above who took the time to offer assistance.</p>\n<p>Moving on. What we want to end up with is three applications:</p>\n<table cellspacing=\"0\">\n  <thead>\n    <tr>\n      <th style=\"text-align:center;\">Application</th>\n      <th style=\"text-align:center;\">Structure/Responsibility</th>\n      <th style=\"text-align:center;\">Talks to</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td>Riak</td>\n      <td>Bomb-proof data storage and replication.</td>\n      <td style=\"text-align:center\">-</td>\n    </tr>\n    <tr>\n      <td>csd_core</td>\n      <td>An OTP application that provides an API to a set of logic that deals with the transformation of data from a client through to the database. It should keep the clients ignorant of the data storage medium. It should provide business logic that would be required for any client application to be able to talk to a `csd`/Riak back-end.</td>\n      <td style=\"text-align:center\">Riak</td>\n    </tr>\n    <tr>\n      <td>csd_web</td>\n      <td>Provide a nice, web-based interface for the user to experience the goal of the Code Smackdown application.</td>\n      <td style=\"text-align:center\">csd_core</td>\n    </tr>\n  </tbody>\n</table>\n\n<p>Given that we're going to be using this structure, the \"root\" folder should actually be fairly clean without any source. Instead, each <code>csd</code>-related application should live in its own sub-folder under an <code>apps</code> folder and the root should just contain the means to build it and start it. In essence what we'd like to see in the root folder is something like this:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ ls -F\napps/  dev.haproxy.conf  Makefile  proxy.sh*  rebar*  rebar.config  start.sh*\n</pre></div>\n\n<p>With that in mind, let's start the surgery.</p>\n<h3 id=\"moving_csd_to_csd_web\">Moving csd to csd_web</h3>\n<p>There are two ways to approach this problem. The first is to do a <strong>find and replace</strong>, making sure you cover off file names as well as module names, etc. The second is to simply <strong>recreate the web site from scratch</strong>, copy over any missing files and make any other adjustments manually that may be required.</p>\n<p>I preferred the second approach, so that's what I did. First I recreated the web application, which is now called <code>csd_web</code> in the <code>apps</code> folder:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ mkdir apps &amp;&amp; cd apps\noj@spawn-link ~/blog/csd/apps $ ~/blog/webmachine/scripts/new_webmachine.sh csd_web .\n==&gt; priv (create)\nWriting /home/oj/blog/csd/apps/csd_web/README\nWriting /home/oj/blog/csd/apps/csd_web/Makefile\nWriting /home/oj/blog/csd/apps/csd_web/rebar.config\nWriting /home/oj/blog/csd/apps/csd_web/rebar\nWriting /home/oj/blog/csd/apps/csd_web/start.sh\nWriting /home/oj/blog/csd/apps/csd_web/ebin/csd_web.app\nWriting /home/oj/blog/csd/apps/csd_web/src/csd_web.erl\nWriting /home/oj/blog/csd/apps/csd_web/src/csd_web_app.erl\nWriting /home/oj/blog/csd/apps/csd_web/src/csd_web_sup.erl\nWriting /home/oj/blog/csd/apps/csd_web/src/csd_web_resource.erl\nWriting /home/oj/blog/csd/apps/csd_web/priv/dispatch.conf\noj@spawn-link ~/blog/csd/apps $ ls -F\ncsd_web/\n</pre></div>\n\n<p>Next I removed a few files which weren't going to be needed any more. I then copied over <code>rebar.config</code>, the ErlyDTL templates and the <code>csd.app.src</code> file (which we need to modify):</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd/apps $ cd csd_web\noj@spawn-link ~/blog/csd/apps/csd_web $ rm README rebar start.sh\noj@spawn-link ~/blog/csd/apps/csd_web $ cp ../../rebar.config .\noj@spawn-link ~/blog/csd/apps/csd_web $ cp -R ../../templates .\noj@spawn-link ~/blog/csd/apps/csd_web $ cp ../../src/csd.app.src ./src/csd_web.app.src\n</pre></div>\n\n<p>I then edited the <code>csd_web.app.src</code> file so that the names were updated (I tidied it up a little and added a version number too):</p>\n<p><span class=\"filename\">apps/csd_web/src/csd_web.app.src</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%%-*- mode: erlang -*-</span>\n<span class=\"p\">{</span><span class=\"n\">application</span><span class=\"p\">,</span> <span class=\"n\">csd_web</span><span class=\"p\">,</span>\n  <span class=\"p\">[</span>\n    <span class=\"p\">{</span><span class=\"n\">description</span><span class=\"p\">,</span> <span class=\"s\">&quot;The Webmachine component of the Code Smackdown application.&quot;</span><span class=\"p\">},</span>\n    <span class=\"p\">{</span><span class=\"n\">vsn</span><span class=\"p\">,</span> <span class=\"s\">&quot;0.0.1&quot;</span><span class=\"p\">},</span>\n    <span class=\"p\">{</span><span class=\"n\">modules</span><span class=\"p\">,</span> <span class=\"p\">[]},</span>\n    <span class=\"p\">{</span><span class=\"n\">registered</span><span class=\"p\">,</span> <span class=\"p\">[]},</span>\n    <span class=\"p\">{</span><span class=\"n\">applications</span><span class=\"p\">,</span>\n      <span class=\"p\">[</span>\n        <span class=\"n\">kernel</span><span class=\"p\">,</span>\n        <span class=\"n\">stdlib</span><span class=\"p\">,</span>\n        <span class=\"n\">crypto</span><span class=\"p\">,</span>\n        <span class=\"n\">mochiweb</span><span class=\"p\">,</span>\n        <span class=\"n\">webmachine</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span><span class=\"n\">mod</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">csd_web_app</span><span class=\"p\">,</span> <span class=\"p\">[]}},</span>\n    <span class=\"p\">{</span><span class=\"n\">env</span><span class=\"p\">,</span> <span class=\"p\">[]}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}.</span>\n</pre></div>\n\n<p>I then opened up <code>csd_web_resource.erl</code> and made it look like the original <code>csd_resource.erl</code> so that it called the ErlyDTL template:</p>\n<p><span class=\"filename\">apps/csd_web/src/csd_web_resource.erl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"p\">-</span><span class=\"ni\">module</span><span class=\"p\">(</span><span class=\"n\">csd_web_resource</span><span class=\"p\">).</span>\n<span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">init</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">to_html</span><span class=\"o\">/</span><span class=\"mi\">2</span><span class=\"p\">]).</span>\n\n<p><span class=\"p\">-</span><span class=\"ni\">include_lib</span><span class=\"p\">(</span><span class=\"s\">&quot;webmachine/include/webmachine.hrl&quot;</span><span class=\"p\">).</span></p>\n<p><span class=\"nf\">init</span><span class=\"p\">([])</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"n\">undefined</span><span class=\"p\">}.</span></p>\n<p><span class=\"nf\">to_html</span><span class=\"p\">(</span><span class=\"nv\">ReqData</span><span class=\"p\">,</span> <span class=\"nv\">State</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"nv\">Content</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nn\">sample_dtl</span><span class=\"p\">:</span><span class=\"n\">render</span><span class=\"p\">([{</span><span class=\"n\">param</span><span class=\"p\">,</span> <span class=\"s\">&quot;Slartibartfast&quot;</span><span class=\"p\">}]),</span>\n  <span class=\"p\">{</span><span class=\"nv\">Content</span><span class=\"p\">,</span> <span class=\"nv\">ReqData</span><span class=\"p\">,</span> <span class=\"nv\">State</span><span class=\"p\">}.</span>\n</pre></div></p>\n<p><code>csd_web</code> is now ready to go. To build it, we need to go back up to the root <code>csd</code> folder and adjust the <code>rebar.config</code> so that it knows to look in the <code>apps</code> sub-folder (thanks to <a href=\"http://twitter.com/andrewtj\" title=\"AndrewTJ on Twitter\">Andrew</a> for <a href=\"http://lists.basho.com/pipermail/rebar_lists.basho.com/2010-October/000246.html\" title=\"Configuring the Rebar apps folder on Basho list\">pointing this out</a>). We can also remove all the dependencies because that will be taken care of by <code>csd_web</code>:</p>\n<p><span class=\"filename\">rebar.config</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%%-*- mode: erlang -*-</span>\n<span class=\"p\">{</span><span class=\"n\">sub_dirs</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s\">&quot;apps/csd_web&quot;</span><span class=\"p\">]}.</span>\n</pre></div>\n\n<p>Next, I removed all the other left-over stuff in the root folder that wasn't required any more (including the startup script):</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ rm -rf README priv src templates start.sh\n</pre></div>\n\n<p>I then modify the <code>Makefile</code> so that it does a couple of other things:</p>\n<ol>\n<li>Includes a target which builds just the current applications <em>without</em> building the dependencies (this will make builds much quicker most of the time).</li>\n<li>Includes a target which can start the web application, essentially replacing the original startup script. This target will be dependent on the previous target so that it is always up to date when running the application.</li>\n<li>Includes targets which can start/stop <code>HAproxy</code>.</li>\n</ol>\n<p><span class=\"filename\">Makefile</span></p>\n<div class=\"pygments_murphy\"><pre>ERL ?= erl\nAPP = csd\n\n.PHONY: deps\n\n<p>all: deps\n    @./rebar compile</p>\n<p>app:\n    @./rebar compile skip_deps=true</p>\n<p>deps:\n    @./rebar get-deps</p>\n<p>clean:\n    @./rebar clean</p>\n<p>distclean: clean\n    @./rebar delete-deps</p>\n<p>webstart: app\n    exec erl -pa $(PWD)/apps/*/ebin -pa $(PWD)/deps/*/ebin -boot start_sasl -s reloader -s csd_web</p>\n<p>proxystart:\n    @haproxy -f dev.haproxy.conf\n</pre></div></p>\n<p>All that is left to do is start <code>haproxy</code> and launch the application (make sure <code>Riak</code> is running first). These commands need to be done in two different terminal windows. First, start the proxy (note the use of <code>sudo</code> so that we can listen on port 80):</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ sudo make proxystart\n[2] 1935\nAvailable polling systems :\n     sepoll : pref=400,  test result OK\n      epoll : pref=300,  test result OK\n       poll : pref=200,  test result OK\n     select : pref=150,  test result OK\nTotal: 4 (4 usable), will use sepoll.\nUsing sepoll() as the polling mechanism.\n</pre></div>\n\n<p>Then make and start the web application. We have to do a full <code>make</code> first time around so that all the dependencies are resolved:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ make &amp;&amp; make webstart\n\n... snip ...\n\n<p>=PROGRESS REPORT==== 4-Apr-2011::21:04:18 ===\n         application: csd_web\n          started_at: nonode@nohost\n</pre></div></p>\n<p>Now we should be able to hit <a href=\"http://localhost/\" title=\"localhost web app\">localhost</a> and see the ErlyDTL template rendered in all its awesome, black-and-white glory:</p>\n<img src=\"http://buffered.io/uploads/2010/10/localhost-slartibartfast.png\" />\n\n<p>Refactor complete. Now let's start work on our new OTP application which will be responsible for talking to Riak.</p>\n<p>If you need a break, now is the time to take it! Go freshen up, take a leak and refill your glass.</p>\n<p>Ready to go again? Here we go ...</p>\n<h3 id=\"creating_the_csd_core_otp_application\">Creating the csd_core OTP Application</h3>\n<p>Creation of an OTP-compliant application is another job for <a href=\"http://www.basho.com/developers.html#Rebar\" title=\"Rebar\">Rebar</a> as it comes with a set of templates built-in. Unfortunately those template aren't 100% and hence don't do everything we need to do out of the box. But we shall use them as a starting point:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ mkdir apps/csd_core &amp;&amp; cd apps/csd_core\noj@spawn-link ~/blog/csd/apps/csd_core $ ../../rebar create-app appid=csd_core\n==&gt; csd_core (create-app)\nWriting src/csd_core.app.src\nWriting src/csd_core_app.erl\nWriting src/csd_core_sup.erl\n</pre></div>\n\n<p>We have a very simple application shell set up, but we need to do a bit more work to get it ready. First, let's create our base <code>csd_core.erl</code> module which is used to fire up our application. For this we will use <code>csd_web.erl</code> (the one which is part of our Webmachine application) as a template. Note that I've shuffled things around and removed some things that are not relevant:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_core.erl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%% @author OJ Reeves &lt;oj@buffered.io&gt;</span>\n<span class=\"c\">%% @copyright 2011 OJ Reeves</span>\n\n<p><span class=\"c\">%% @doc csd_core startup code</span></p>\n<p><span class=\"p\">-</span><span class=\"ni\">module</span><span class=\"p\">(</span><span class=\"n\">csd_core</span><span class=\"p\">).</span>\n<span class=\"p\">-</span><span class=\"ni\">author</span><span class=\"p\">(</span><span class=\"n\">&#39;OJ Reeves &lt;oj@buffered.io&gt;&#39;</span><span class=\"p\">).</span>\n<span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">start</span><span class=\"o\">/</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">start_link</span><span class=\"o\">/</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">stop</span><span class=\"o\">/</span><span class=\"mi\">0</span><span class=\"p\">]).</span></p>\n<p><span class=\"nf\">ensure_started</span><span class=\"p\">(</span><span class=\"nv\">App</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n    <span class=\"k\">case</span> <span class=\"nn\">application</span><span class=\"p\">:</span><span class=\"n\">start</span><span class=\"p\">(</span><span class=\"nv\">App</span><span class=\"p\">)</span> <span class=\"k\">of</span>\n        <span class=\"n\">ok</span> <span class=\"o\">-&gt;</span>\n            <span class=\"n\">ok</span><span class=\"p\">;</span>\n        <span class=\"p\">{</span><span class=\"n\">error</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">already_started</span><span class=\"p\">,</span> <span class=\"nv\">App</span><span class=\"p\">}}</span> <span class=\"o\">-&gt;</span>\n            <span class=\"n\">ok</span>\n    <span class=\"k\">end</span><span class=\"p\">.</span></p>\n<p><span class=\"c\">%% @spec start_link() -&gt; {ok,Pid::pid()}</span>\n<span class=\"c\">%% @doc Starts the app for inclusion in a supervisor tree</span>\n<span class=\"nf\">start_link</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n    <span class=\"n\">ensure_started</span><span class=\"p\">(</span><span class=\"n\">crypto</span><span class=\"p\">),</span>\n    <span class=\"nn\">csd_core_sup</span><span class=\"p\">:</span><span class=\"n\">start_link</span><span class=\"p\">().</span></p>\n<p><span class=\"c\">%% @spec start() -&gt; ok</span>\n<span class=\"c\">%% @doc Start the csd_core server.</span>\n<span class=\"nf\">start</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n    <span class=\"n\">ensure_started</span><span class=\"p\">(</span><span class=\"n\">crypto</span><span class=\"p\">),</span>\n    <span class=\"nn\">application</span><span class=\"p\">:</span><span class=\"n\">start</span><span class=\"p\">(</span><span class=\"n\">csd_core</span><span class=\"p\">).</span></p>\n<p><span class=\"c\">%% @spec stop() -&gt; ok</span>\n<span class=\"c\">%% @doc Stop the csd_core server.</span>\n<span class=\"nf\">stop</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n    <span class=\"nv\">Res</span> <span class=\"o\">=</span> <span class=\"nn\">application</span><span class=\"p\">:</span><span class=\"n\">stop</span><span class=\"p\">(</span><span class=\"n\">csd_core</span><span class=\"p\">),</span>\n    <span class=\"nn\">application</span><span class=\"p\">:</span><span class=\"n\">stop</span><span class=\"p\">(</span><span class=\"n\">crypto</span><span class=\"p\">),</span>\n    <span class=\"nv\">Res</span><span class=\"p\">.</span>\n</pre></div></p>\n<p>Next up, edit <code>csd_core.app.src</code> and add some application-specific information:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_core.app.src</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"p\">{</span><span class=\"n\">application</span><span class=\"p\">,</span> <span class=\"n\">csd_core</span><span class=\"p\">,</span>\n  <span class=\"p\">[</span>\n    <span class=\"p\">{</span><span class=\"n\">description</span><span class=\"p\">,</span> <span class=\"s\">&quot;Core functionality for the Code Smackdown application.&quot;</span><span class=\"p\">},</span>\n    <span class=\"p\">{</span><span class=\"n\">vsn</span><span class=\"p\">,</span> <span class=\"s\">&quot;0.0.1&quot;</span><span class=\"p\">},</span>\n    <span class=\"p\">{</span><span class=\"n\">registered</span><span class=\"p\">,</span> <span class=\"p\">[]},</span>\n    <span class=\"p\">{</span><span class=\"n\">applications</span><span class=\"p\">,</span>\n      <span class=\"p\">[</span>\n        <span class=\"n\">kernel</span><span class=\"p\">,</span>\n        <span class=\"n\">stdlib</span>\n      <span class=\"p\">]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span><span class=\"n\">mod</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">csd_core_app</span><span class=\"p\">,</span> <span class=\"p\">[]}},</span>\n    <span class=\"p\">{</span><span class=\"n\">env</span><span class=\"p\">,</span> <span class=\"p\">[]}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}.</span>\n</pre></div>\n\n<p>We know that we'll be talking to Riak, so we need to make sure we've included the <code>riakc</code> (Riak client) dependency. Though I haven't yet talked about it, we'll also be using Mochiweb's <a href=\"https://github.com/mochi/mochiweb/blob/master/src/mochijson2.erl\" title=\"Mochiweb&apos;s json module\">mochijson2</a> module to help with handling JSON data, so we shall add this as a dependency to the application. Bear in mind this is already a dependency for the web component of the application, so we're not actually adding a <em>new</em> dependency to the overall application.</p>\n<p>We can do this by creating a <code>rebar.config</code> in <code>apps/csd_core</code> and editing it to contain the following:</p>\n<p><span class=\"filename\">apps/csd_core/rebar.config</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%%-*- mode: erlang -*-</span>\n<span class=\"p\">{</span><span class=\"n\">deps</span><span class=\"p\">,</span>\n  <span class=\"p\">[</span>\n    <span class=\"p\">{</span><span class=\"n\">mochiweb</span><span class=\"p\">,</span> <span class=\"s\">&quot;1.5.1&quot;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">git</span><span class=\"p\">,</span> <span class=\"s\">&quot;git://github.com/mochi/mochiweb&quot;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">tag</span><span class=\"p\">,</span> <span class=\"s\">&quot;1.5.1&quot;</span><span class=\"p\">}}},</span>\n    <span class=\"p\">{</span><span class=\"n\">riakc</span><span class=\"p\">,</span> <span class=\"s\">&quot;.*&quot;</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">git</span><span class=\"p\">,</span> <span class=\"s\">&quot;git://github.com/basho/riak-erlang-client&quot;</span><span class=\"p\">,</span> <span class=\"s\">&quot;HEAD&quot;</span><span class=\"p\">}}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}.</span>\n</pre></div>\n\n<p>Then we need to tell <code>rebar</code> to build this new application by adjusting the <code>rebar.config</code> in the <code>csd</code> root folder:</p>\n<p><span class=\"filename\">rebar.config</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%%-*- mode: erlang -*-</span>\n<span class=\"p\">{</span><span class=\"n\">sub_dirs</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s\">&quot;apps/csd_core&quot;</span><span class=\"p\">,</span> <span class=\"s\">&quot;apps/csd_web&quot;</span><span class=\"p\">]}.</span>\n</pre></div>\n\n<p>Now we have enough to get the <code>csd_core</code> application started, even though it doesn't do anything. We just need to adjust our <code>Makefile</code> target so that it launches the <code>csd_core</code> application as well:</p>\n<p><span class=\"filename\">Makefile</span></p>\n<div class=\"pygments_murphy\"><pre>ERL ?= erl\nAPP = csd\n\n.PHONY: deps\n\n<p>all: deps\n    @./rebar compile</p>\n<p>app:\n    @./rebar compile skip_deps=true</p>\n<p>deps:\n    @./rebar get-deps</p>\n<p>clean:\n    @./rebar clean</p>\n<p>distclean: clean\n    @./rebar delete-deps</p>\n<p>webstart: app\n    exec erl -pa $(PWD)/apps/*/ebin -pa $(PWD)/deps/*/ebin -boot start_sasl -s reloader -s csd_core -s csd_web</p>\n<p>proxystart:\n    @haproxy -f dev.haproxy.conf\n</pre></div></p>\n<p>Then off we go:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ make webstart\n==&gt; csd_core (compile)\nCompiled src/csd_core_app.erl\nCompiled src/csd_core_sup.erl\nCompiled src/csd_core.erl\n\n... snip ...\n\n<p>=PROGRESS REPORT==== 4-Apr-2011::21:49:27 ===\n         application: csd_core\n          started_at: nonode@nohost</p>\n<p>... snip ...</p>\n<p>=PROGRESS REPORT==== 4-Apr-2011::21:49:27 ===\n         application: csd_web\n          started_at: nonode@nohost\n</pre></div></p>\n<p>As you can see we now have a system which contains both <code>csd_core</code> and <code>csd_web</code>. This is great, but <code>csd_core</code> needs a lot more work. The intent for this application is to be an <a href=\"http://en.wikipedia.org/wiki/Open_Telecom_Platform\" title=\"Open Telecom Platform\">OTP</a> application which provides an API to the <code>csd</code> logic and back-end database. This means we're going to need to get ourselves a <a href=\"http://www.erlang.org/doc/design_principles/gen_server_concepts.html\" title=\"gen_server behaviour\">gen_server</a> set up which can handle requests from various clients. Let's do that next.</p>\n<p>Thankfully <code>rebar</code> comes with a simple template that we can use for creating the <code>gen_server</code> behaviour, so we can invoke that from the command line and have it generate the shell for us:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd/apps/csd_core $ ../../rebar create template=simplesrv srvid=csd_core_server\n==&gt; csd_core (create)\nWriting src/csd_core_server.erl\n</pre></div>\n\n<p>We now have a very dumb server ready to go, to make it start with the rest of the application we have to modify <code>csd_core_sup</code>, the <a href=\"http://www.erlang.org/doc/design_principles/sup_princ.html\" title=\"supervisor behaviour\">supervisor</a> and tell it to fire up the server for us:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_core_sup.erl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"p\">-</span><span class=\"ni\">module</span><span class=\"p\">(</span><span class=\"n\">csd_core_sup</span><span class=\"p\">).</span>\n\n<p><span class=\"p\">-</span><span class=\"ni\">behaviour</span><span class=\"p\">(</span><span class=\"n\">supervisor</span><span class=\"p\">).</span></p>\n<p><span class=\"c\">%% API</span>\n<span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">start_link</span><span class=\"o\">/</span><span class=\"mi\">0</span><span class=\"p\">]).</span></p>\n<p><span class=\"c\">%% Supervisor callbacks</span>\n<span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">init</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">]).</span></p>\n<p><span class=\"c\">%% Helper macro for declaring children of supervisor</span>\n<span class=\"p\">-</span><span class=\"ni\">define</span><span class=\"p\">(</span><span class=\"no\">CHILD</span><span class=\"p\">(</span><span class=\"nv\">I</span><span class=\"p\">,</span> <span class=\"nv\">Type</span><span class=\"p\">),</span> <span class=\"p\">{</span><span class=\"nv\">I</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"nv\">I</span><span class=\"p\">,</span> <span class=\"n\">start_link</span><span class=\"p\">,</span> <span class=\"p\">[]},</span> <span class=\"n\">permanent</span><span class=\"p\">,</span> <span class=\"mi\">5000</span><span class=\"p\">,</span> <span class=\"nv\">Type</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"nv\">I</span><span class=\"p\">]}).</span></p>\n<p><span class=\"c\">%% ===================================================================</span>\n<span class=\"c\">%% API functions</span>\n<span class=\"c\">%% ===================================================================</span></p>\n<p><span class=\"nf\">start_link</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">supervisor</span><span class=\"p\">:</span><span class=\"n\">start_link</span><span class=\"p\">({</span><span class=\"n\">local</span><span class=\"p\">,</span> <span class=\"no\">?MODULE</span><span class=\"p\">},</span> <span class=\"no\">?MODULE</span><span class=\"p\">,</span> <span class=\"p\">[]).</span></p>\n<p><span class=\"c\">%% ===================================================================</span>\n<span class=\"c\">%% Supervisor callbacks</span>\n<span class=\"c\">%% ===================================================================</span></p>\n<p><span class=\"nf\">init</span><span class=\"p\">([])</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">Server</span> <span class=\"o\">=</span> <span class=\"no\">?CHILD</span><span class=\"p\">(</span><span class=\"n\">csd_core_server</span><span class=\"p\">,</span> <span class=\"n\">worker</span><span class=\"p\">),</span>\n  <span class=\"nv\">Processes</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"nv\">Server</span><span class=\"p\">],</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"p\">{</span><span class=\"n\">one_for_one</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">,</span> <span class=\"mi\">10</span><span class=\"p\">},</span> <span class=\"nv\">Processes</span><span class=\"p\">}</span> <span class=\"p\">}.</span>\n</pre></div></p>\n<p>With this in place we can now start our application again and we should see the new <code>csd_core_server</code> appear in the start-up sequence:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd $ make webstart\n\n... snip ...\n\n<p>=PROGRESS REPORT==== 4-Apr-2011::22:04:04 ===\n          supervisor: {local,csd_core_sup}\n             started: [{pid,&lt;0.54.0&gt;},\n                       {name,csd_core_server},\n                       {mfargs,{csd_core_server,start_link,[]}},\n                       {restart_type,permanent},\n                       {shutdown,5000},\n                       {child_type,worker}]</p>\n<p>=PROGRESS REPORT==== 4-Apr-2011::22:04:04 ===\n         application: csd_core\n          started_at: nonode@nohost</p>\n<p>... snip ...\n</pre></div></p>\n<p>The shell and structure of our application is now in place. We are finally ready to start talking to Riak!</p>\n<p>Again, now is the time to have a mini-break if you need one. Grab a <em>Shigar und a waffle</em> and a cup of English Breakfast tea.</p>\n<h2>Preparing csd_core for Riak connectivity</h2>\n<p>Given that this is the first look at connecting to Riak, we're going to have to set up a little infrastructure to support our needs. As a result, the data itself won't be discussed much for fear of turning this post into something way more epic than originally intended.</p>\n<p>So in short, we're interested in storing the idea of a <em>code snippet</em>. That is an entity which contains two opposing blobs of code which are being compared. That snippet will have a title. Down the track, more information will be associated with this snippet, such as the author, along with links to a set of comments and votes. For now we'll just focus on storing the bare essentials of the snippet.</p>\n<h3 id=\"the_snippet\">The Snippet</h3>\n<p>As far as our Erlang code is concerned, our snippet is going to be a simple list of properties that we can interact with via the <a href=\"http://www.erlang.org/doc/man/proplists.html\" title=\"proplists\">proplists</a> module. This keeps things really simple. To demonstrate what our snippet will look like in code, here is the function that takes a Title, and the two code blobs (called Left and Right) and returns a <code>snippet</code> instance. This code goes in a module called <code>csd_snippet</code> defined in <code>src/csd_snippet.erl</code>:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_snippet.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"nf\">to_snippet</span><span class=\"p\">(</span><span class=\"nv\">Title</span><span class=\"p\">,</span> <span class=\"nv\">Left</span><span class=\"p\">,</span> <span class=\"nv\">Right</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">snippet</span><span class=\"p\">,</span>\n    <span class=\"p\">[</span>\n      <span class=\"p\">{</span><span class=\"n\">title</span><span class=\"p\">,</span> <span class=\"nv\">Title</span><span class=\"p\">},</span>\n      <span class=\"p\">{</span><span class=\"n\">left</span><span class=\"p\">,</span> <span class=\"nv\">Left</span><span class=\"p\">},</span>\n      <span class=\"p\">{</span><span class=\"n\">right</span><span class=\"p\">,</span> <span class=\"nv\">Right</span><span class=\"p\">}</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">}.</span>\n</pre></div>\n\n<p>Note that the first part of the tuple is the atom <code>snippet</code> which I am using to identify the layout of the contents in the second part of the tuple. Down the track we'll have more collections of data in the system than just snippets, and we may want to make sure that the caller doesn't accidentally pass in a <code>user</code>, for example, to a function expecting a <code>snippet</code>.</p>\n<p>It is important at this point to note that, down the track, I will include a <code>key</code> property in all of the data objects that are pushed to Riak. This property serves as the identifier for the object in Riak and is stored alongside the rest of the data so that it is easy to relate the in-memory instance back to the stored instance. This value, if not specified, will be inserted automatically when an item is saved via the API functions in <code>csd_core</code>. More on this later.</p>\n<h3 id=\"formatting_data_for_storage_in_riak\">Formatting Data for Storage in Riak</h3>\n<p>Riak is very flexible in that it will store whatever kind of information you give it. This is good because it means we can cater our data format to whatever needs we have.</p>\n<p>In our case, the <em>easiest</em> option would be to store our Erlang terms as binary using [term_to_binary][] as we wouldn't have to think about <em>anything</em> else. We could easily read the data using [binary_to_term][]. Done.</p>\n<p>This comes with a set of problems though. For example, if we wanted to <a href=\"http://en.wikipedia.org/wiki/MapReduce\" title=\"map/reduce\">map/reduce</a> using JavaScript we wouldn't find it easy to get the data into a format that we could use. Another example would be that the RESTful interface to Riak would be close to useless because <strong>any</strong> non-Erlang client would have to somehow get the data into a meaningful format to work with.</p>\n<p>Instead of using binary and throwing Erlang terms straight into Riak, we're going to use <a href=\"http://json.org/\" title=\"JavaScript Object Notation\">JSON</a>. It's very easy to convert to and from JSON in many different languages, and it's very easy to read. We can also easily verify that the data is being stored correctly by querying Riak's RESTful interface directly using <a href=\"http://curl.haxx.se/\" title=\"cURL homepage\">cURL</a> or a browser.</p>\n<p>In order to store data in JSON format, we're going to enlist the help of <a href=\"https://github.com/mochi/mochiweb/blob/master/src/mochijson2.erl\" title=\"Mochiweb&apos;s json module\">mochijson2</a>, a library that comes with <a href=\"https://github.com/mochi/mochiweb\" title=\"Mochiweb\">Mochiweb</a> that makes it a <em>lot</em> easier to deal with JSON than doing everything manually. Given that we're using Webmachine for the front-end (which itself relies on Mochiweb) we already have the dependency available.</p>\n<p>Unfortunately we can't just throw our data straight at this module and have it do everything for us. <code>mochijson2</code> requires data to be in a certain format before it can encode it to JSON. When decoding <em>from</em> JSON, it converts the data into the same format. Hence, we need the ability to convert our own data format to and from this intermediate data format so that <code>mochijson2</code> can deal with it.</p>\n<p>We need two functions: <code>to_json()</code> and <code>from_json()</code>, and we shall define these in a helper module called <code>csd_json</code>. This module will live in <code>csd_core</code>:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_json.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"p\">-</span><span class=\"ni\">module</span><span class=\"p\">(</span><span class=\"n\">csd_json</span><span class=\"p\">).</span>\n<span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">from_json</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">from_json</span><span class=\"o\">/</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">to_json</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">to_json</span><span class=\"o\">/</span><span class=\"mi\">2</span><span class=\"p\">]).</span>\n\n<p><span class=\"nf\">to_json</span><span class=\"p\">(</span><span class=\"nv\">PropList</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"n\">to_json</span><span class=\"p\">(</span><span class=\"nv\">PropList</span><span class=\"p\">,</span> <span class=\"k\">fun</span><span class=\"p\">(_)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">true</span> <span class=\"k\">end</span><span class=\"p\">).</span></p>\n<p><span class=\"nf\">to_json</span><span class=\"p\">(</span><span class=\"nv\">PropList</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nb\">list_to_binary</span><span class=\"p\">(</span><span class=\"nn\">mochijson2</span><span class=\"p\">:</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"n\">from_proplist</span><span class=\"p\">(</span><span class=\"nv\">PropList</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">))).</span></p>\n<p><span class=\"nf\">from_json</span><span class=\"p\">(</span><span class=\"nv\">Json</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"n\">from_json</span><span class=\"p\">(</span><span class=\"nv\">Json</span><span class=\"p\">,</span> <span class=\"k\">fun</span><span class=\"p\">(_)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">true</span> <span class=\"k\">end</span><span class=\"p\">).</span></p>\n<p><span class=\"nf\">from_json</span><span class=\"p\">(</span><span class=\"nv\">Json</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"n\">to_proplist</span><span class=\"p\">(</span><span class=\"nn\">mochijson2</span><span class=\"p\">:</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"nv\">Json</span><span class=\"p\">),</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">).</span>\n</pre></div></p>\n<p>You're probably wondering why each of these functions requires the <code>IsStrFun</code> parameter (if you're not, you're obviously an experienced Erlanger!). For those who don't know, strings in Erlang are actually lists of integers. This is fantastic as it makes it easy to manipulate strings as if they were lists, but it comes at a small price: it's not possible to determine the difference between a list of integers and a string.</p>\n<p>Why is this important? <code>mochijson2</code> needs strings to be encoded as binaries, so we need a way to differentiate between integer lists and real strings. My original implementations of both the <code>to_json()</code> and <code>from_json()</code> functions attempted to figure out if certain fields were strings or not by looking at the content of the list. Not only was the code messy, but it wasn't foolproof. Instead, I made the decision to force the user to provide a callback function which will tell the JSON serialiser if the given property is a string or not. This callback takes a single parameter which is the name (in atom form) of the property and returns a boolean -- <code>true</code> indicates that the value is a string, <code>false</code> otherwise.</p>\n<p>In some cases we might just be happy to encode/decode every single value as a string. Hence, there is an overload to both <code>to_json()</code> and <code>from_json()</code> which caters for this case. The rest of the code which implments the conversion is listed below. Don't feel that you need to understand the code below, as it's really not the goal of this post. The full source to this module is included in the source link specified at the end of this post.</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_json.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"nf\">from_proplist</span><span class=\"p\">(</span><span class=\"nv\">List</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"nv\">H</span><span class=\"p\">|_],</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_tuple</span><span class=\"p\">(</span><span class=\"nv\">H</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span> <span class=\"n\">struct</span><span class=\"p\">,</span> <span class=\"nn\">lists</span><span class=\"p\">:</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"k\">fun</span><span class=\"p\">(</span><span class=\"nv\">P</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">from_proplist</span><span class=\"p\">(</span><span class=\"nv\">P</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">end</span><span class=\"p\">,</span> <span class=\"nv\">List</span><span class=\"p\">)</span> <span class=\"p\">};</span>\n<span class=\"nf\">from_proplist</span><span class=\"p\">({</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">ComplexProp</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"nv\">H</span><span class=\"p\">|_]},</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_tuple</span><span class=\"p\">(</span><span class=\"nv\">H</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span> <span class=\"nb\">list_to_binary</span><span class=\"p\">(</span><span class=\"nb\">atom_to_list</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">)),</span> <span class=\"n\">from_proplist</span><span class=\"p\">(</span><span class=\"nv\">ComplexProp</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"p\">};</span>\n<span class=\"nf\">from_proplist</span><span class=\"p\">({</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">PropVal</span><span class=\"p\">},</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span> <span class=\"nb\">list_to_binary</span><span class=\"p\">(</span><span class=\"nb\">atom_to_list</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">)),</span> <span class=\"n\">to_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">PropVal</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"p\">}.</span>\n\n<p><span class=\"nf\">to_proplist</span><span class=\"p\">({</span><span class=\"n\">struct</span><span class=\"p\">,</span> <span class=\"nv\">PropList</span><span class=\"p\">},</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_list</span><span class=\"p\">(</span><span class=\"nv\">PropList</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">lists</span><span class=\"p\">:</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"k\">fun</span><span class=\"p\">(</span><span class=\"nv\">P</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">to_proplist</span><span class=\"p\">(</span><span class=\"nv\">P</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">end</span><span class=\"p\">,</span> <span class=\"nv\">PropList</span><span class=\"p\">);</span>\n<span class=\"nf\">to_proplist</span><span class=\"p\">({</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">ComplexProp</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"n\">struct</span><span class=\"p\">,</span> <span class=\"p\">_}},</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span> <span class=\"nb\">list_to_atom</span><span class=\"p\">(</span><span class=\"nb\">binary_to_list</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">)),</span> <span class=\"n\">to_proplist</span><span class=\"p\">(</span><span class=\"nv\">ComplexProp</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"p\">};</span>\n<span class=\"nf\">to_proplist</span><span class=\"p\">({</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">PropVal</span><span class=\"p\">},</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">PropAtom</span> <span class=\"o\">=</span> <span class=\"nb\">list_to_atom</span><span class=\"p\">(</span><span class=\"nb\">binary_to_list</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">)),</span>\n  <span class=\"p\">{</span> <span class=\"nv\">PropAtom</span><span class=\"p\">,</span> <span class=\"n\">from_value</span><span class=\"p\">(</span><span class=\"nv\">PropAtom</span><span class=\"p\">,</span> <span class=\"nv\">PropVal</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"p\">}.</span></p>\n<p><span class=\"nf\">to_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">L</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"nv\">H</span><span class=\"p\">|_],</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_list</span><span class=\"p\">(</span><span class=\"nv\">L</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"nb\">is_list</span><span class=\"p\">(</span><span class=\"nv\">H</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">lists</span><span class=\"p\">:</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"k\">fun</span><span class=\"p\">(</span><span class=\"nv\">P</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">to_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">P</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">end</span><span class=\"p\">,</span> <span class=\"nv\">L</span><span class=\"p\">);</span>\n<span class=\"nf\">to_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">L</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_list</span><span class=\"p\">(</span><span class=\"nv\">L</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"k\">case</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">)</span> <span class=\"k\">of</span>\n    <span class=\"n\">true</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">list_to_binary</span><span class=\"p\">(</span><span class=\"nv\">L</span><span class=\"p\">);</span>\n    <span class=\"p\">_</span> <span class=\"o\">-&gt;</span> <span class=\"nn\">lists</span><span class=\"p\">:</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"k\">fun</span><span class=\"p\">(</span><span class=\"nv\">V</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">to_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">V</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">end</span><span class=\"p\">,</span> <span class=\"nv\">L</span><span class=\"p\">)</span>\n  <span class=\"k\">end</span><span class=\"p\">;</span>\n<span class=\"nf\">to_value</span><span class=\"p\">(_,</span> <span class=\"nv\">V</span><span class=\"p\">,</span> <span class=\"p\">_)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">V</span><span class=\"p\">.</span></p>\n<p><span class=\"nf\">from_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">L</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_list</span><span class=\"p\">(</span><span class=\"nv\">L</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">lists</span><span class=\"p\">:</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"k\">fun</span><span class=\"p\">(</span><span class=\"nv\">P</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">from_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">P</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">end</span><span class=\"p\">,</span> <span class=\"nv\">L</span><span class=\"p\">);</span>\n<span class=\"nf\">from_value</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">,</span> <span class=\"nv\">B</span><span class=\"p\">,</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">)</span> <span class=\"k\">when</span> <span class=\"nb\">is_binary</span><span class=\"p\">(</span><span class=\"nv\">B</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"k\">case</span> <span class=\"nv\">IsStrFun</span><span class=\"p\">(</span><span class=\"nv\">PropName</span><span class=\"p\">)</span> <span class=\"k\">of</span>\n    <span class=\"n\">true</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">binary_to_list</span><span class=\"p\">(</span><span class=\"nv\">B</span><span class=\"p\">);</span>\n    <span class=\"p\">_</span> <span class=\"o\">-&gt;</span> <span class=\"nv\">B</span>\n  <span class=\"k\">end</span><span class=\"p\">;</span>\n<span class=\"nf\">from_value</span><span class=\"p\">(_,</span> <span class=\"nv\">V</span><span class=\"p\">,</span> <span class=\"p\">_)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">V</span><span class=\"p\">.</span>\n</pre></div></p>\n<p>We are now able to read and write data to and from JSON format. Now we need to use the Riak client to push that into our Riak cluster.</p>\n<h3 id=\"setting_up_the_riak_client\">Setting up the Riak client</h3>\n<p>Basho have done a great job of creating a protocol buffer-based client for use with Riak. The interface is really simple to use. Despite that, we shall create a module which will deal with this for us. This gives us a single point of abstraction of Riak and a place where we can add extra support for our own needs without spreading Riak-specific code all over the source base.</p>\n<p>The first problem we need to resolve is: <em>what do we do with configuration?</em></p>\n<p>This was a question I initially didn't know how to answer. After a bit of deliberation and a chat with a <a href=\"http://twitter.com/mononcqc\" title=\"Ferd T-H on Twitter\">respected Erlang sifu</a> (who has a <a href=\"http://learnyousomeerlang.com/\" title=\"Learng you some erlang\">fantastic Erlang tutorial site</a>) I decided to go with a module-based option.</p>\n<p>We have our Riak cluster hidden behind the <code>haproxy</code> load balancer, and hence we have a single entry-point to connect to. If this entry-point changes, it changes for all of the clients, not just a single client. Therefore, I want the ability to manage a single set of connection information, but I want the ability to update it on the fly without having to restart the <code>csd_core</code> application. This is Erlang, after all, and modifying code and configuration on-the-fly is extremely easy. We shall abuse that.</p>\n<p>We create a single module, <code>csd_riak_config.erl</code>, to contain our configuration which is referenced at start-up. It looks like this:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_riak_config.erl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"p\">-</span><span class=\"ni\">module</span><span class=\"p\">(</span><span class=\"n\">csd_riak_config</span><span class=\"p\">).</span>\n<span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">connection_info</span><span class=\"o\">/</span><span class=\"mi\">0</span><span class=\"p\">]).</span>\n\n<p><span class=\"nf\">connection_info</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span> <span class=\"s\">&quot;127.0.0.1&quot;</span><span class=\"p\">,</span> <span class=\"mi\">8080</span> <span class=\"p\">}.</span>\n</pre></div></p>\n<p>Pretty simple stuff. Let's use this functionality in our <code>gen_server</code>, and carry the configuration through from initialisation to all of the calls that will be made to the Riak server. This requires two simple modifications to the <code>csd_core_server</code> module:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_core_server.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"nf\">start_link</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">ConnInfo</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak_config</span><span class=\"p\">:</span><span class=\"n\">connection_info</span><span class=\"p\">(),</span>\n  <span class=\"nn\">gen_server</span><span class=\"p\">:</span><span class=\"n\">start_link</span><span class=\"p\">({</span><span class=\"n\">local</span><span class=\"p\">,</span> <span class=\"no\">?SERVER</span><span class=\"p\">},</span> <span class=\"no\">?MODULE</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"nv\">ConnInfo</span><span class=\"p\">],</span> <span class=\"p\">[]).</span>\n\n<p><span class=\"c\">% ...</span></p>\n<p><span class=\"nf\">init</span><span class=\"p\">([</span><span class=\"nv\">ConnInfo</span><span class=\"p\">])</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"nv\">ConnInfo</span><span class=\"p\">}.</span>\n</pre></div></p>\n<p>Confiuration is now loaded and is being passed to all of our <code>gen_server</code> callbacks. Let's make use of it. <code>csd_snippet</code> is the entry point for all snippet-related information, and one of the things that we are going to want to be able to do is write a snippet to Riak. So let's create a code-path that can do that.</p>\n<h4 id=\"writing_data_to_riak\">Writing Data to Riak</h4>\n<p>The first point of call for a client is the OTP interface. Let's create an API call and a call handler to support saving snippets in <code>csd_core_server</code>:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_core_server.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%% This is a simple function which invokes a call via the gen_sever</span>\n<span class=\"c\">%% behaviour.</span>\n<span class=\"nf\">save_snippet</span><span class=\"p\">(</span><span class=\"nv\">Snippet</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">gen_server</span><span class=\"p\">:</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"no\">?SERVER</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">save_snippet</span><span class=\"p\">,</span> <span class=\"nv\">Snippet</span><span class=\"p\">},</span> <span class=\"n\">infinity</span><span class=\"p\">).</span>\n\n<p><span class=\"c\">%% Handle the case where a caller wants to save a snippet to Riak. We</span>\n<span class=\"c\">%% create a connection to Riak and pass that into the snippet handler</span>\n<span class=\"c\">%% along with the snippet that needs to be saved. We return the newly</span>\n<span class=\"c\">%% saved snippet.</span>\n<span class=\"nf\">handle_call</span><span class=\"p\">({</span><span class=\"n\">save_snippet</span><span class=\"p\">,</span> <span class=\"nv\">Snippet</span><span class=\"p\">},</span> <span class=\"p\">_</span><span class=\"nv\">From</span><span class=\"p\">,</span> <span class=\"nv\">ConnInfo</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">RiakPid</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"nv\">ConnInfo</span><span class=\"p\">),</span>\n  <span class=\"nv\">SavedSnippet</span> <span class=\"o\">=</span> <span class=\"nn\">csd_snippet</span><span class=\"p\">:</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">Snippet</span><span class=\"p\">),</span>\n  <span class=\"p\">{</span><span class=\"n\">reply</span><span class=\"p\">,</span> <span class=\"nv\">SavedSnippet</span><span class=\"p\">,</span> <span class=\"nv\">ConnInfo</span><span class=\"p\">};</span>\n</pre></div></p>\n<p>Of course, we will need to export the <code>save_snippet()</code> function if we want to be able to call it.</p>\n<p>You'll notice that we're getting the connection information passed in as the state for the OTP call, and that we're using that to create a connection to Riak via the <code>csd_riak</code> module. We shall cover this module in just a minute, but hopefully the interface to this function should make it relatively self-explanatory.</p>\n<p>You might be wondering \"Why are you creating the Riak client connection here instead of letting the <code>csd_snippet:save()</code> function do it by itself. It's a good question. The reason I decided to create the connection as part of OTP call rather than in the data/helper modules is because down the track there will probably be a need to do multiple interactions with Riak in a single call. If we force each of the called modules, such as <code>csd_snippet</code>, to establish their own connections then we'd probably have <em>multiple connections to Riak being created during a single client request</em>. This isn't what I would like to see happen, so it made sense (in my view) to create the client connection once and reuse it across all modules that are invoked during the request.</p>\n<p>With that out of the way, we need to implement the <code>save()</code> function in the <code>csd_snippet</code> module. Brace yourself:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_snippet.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">Snippet</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"n\">snippet</span><span class=\"p\">,</span> <span class=\"nv\">SnippetData</span><span class=\"p\">})</span> <span class=\"o\">-&gt;</span>\n  <span class=\"k\">case</span> <span class=\"nn\">proplists</span><span class=\"p\">:</span><span class=\"n\">get_value</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"nv\">SnippetData</span><span class=\"p\">,</span> <span class=\"n\">undefined</span><span class=\"p\">)</span> <span class=\"k\">of</span>\n    <span class=\"n\">undefined</span> <span class=\"o\">-&gt;</span>\n      <span class=\"nv\">Key</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">new_key</span><span class=\"p\">(),</span>\n      <span class=\"nv\">NewSnippetData</span> <span class=\"o\">=</span> <span class=\"p\">[{</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">}</span> <span class=\"p\">|</span> <span class=\"nv\">SnippetData</span><span class=\"p\">],</span>\n      <span class=\"nv\">RiakObj</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"no\">?BUCKET</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">,</span> <span class=\"n\">to_json_internal</span><span class=\"p\">(</span><span class=\"nv\">NewSnippetData</span><span class=\"p\">)),</span>\n      <span class=\"n\">ok</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">RiakObj</span><span class=\"p\">),</span>\n      <span class=\"p\">{</span><span class=\"n\">snippet</span><span class=\"p\">,</span> <span class=\"nv\">NewSnippetData</span><span class=\"p\">};</span>\n    <span class=\"nv\">ExistingKey</span> <span class=\"o\">-&gt;</span>\n      <span class=\"nv\">RiakObj</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">fetch</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"no\">?BUCKET</span><span class=\"p\">,</span> <span class=\"nv\">ExistingKey</span><span class=\"p\">),</span>\n      <span class=\"nv\">NewRiakObj</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"nv\">RiakObj</span><span class=\"p\">,</span> <span class=\"n\">to_json_internal</span><span class=\"p\">(</span><span class=\"nv\">SnippetData</span><span class=\"p\">)),</span>\n      <span class=\"n\">ok</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">NewRiakObj</span><span class=\"p\">),</span>\n      <span class=\"nv\">Snippet</span>\n  <span class=\"k\">end</span><span class=\"p\">.</span>\n</pre></div>\n\n<p>On the surface this looks a little complicated, but it's actually very simple. As mentioned earlier in the post, we use a <code>key</code> property to store the identifier of the object in Riak. This code supports this notion. It works as follows:</p>\n<ol>\n<li><strong>Try to get the value of the <code>key</code> from the given list of properties.</strong></li>\n<li><strong>If <em>not</em> found ...</strong><ol>\n<li>create a new key using the <code>new_key()</code> function in the <code>csd_riak</code> module (this will be covered shortly).</li>\n<li>Add the <code>key</code> to the list of properties for the snippet.</li>\n<li>Create a new instance of a Riak object (more on this later) which contains the details of the snippet data to be written, along with the target bucket name and the key of the snippet.</li>\n<li>Save the Riak object to the Riak cluster using the specified Riak client connection (Pid), and for now assume that it succeeds.</li>\n<li>Return the new set of snippet data with the snippet's key included.</li>\n</ol>\n</li>\n<li><strong>If found ...</strong><ol>\n<li>Load the existing data from the Riak cluster into a Riak object.</li>\n<li>Update the Riak object with the new data values passed into the function.</li>\n<li>Save the Riak object <em>back</em> to the Riak cluster using the specified Riak client connection (Pid), and for now assume that it succeeds.</li>\n<li>Return the snippet back to the caller as is.</li>\n</ol>\n</li>\n</ol>\n<p>It's fairly basic functionality which does enough to cater for our needs at this point. Through this one function, we can write new snippet instances to Riak, and we can update them too.</p>\n<p>You'll also notice that another function is being called that hasn't been discussed: <code>to_snippet_internal()</code>. Rather than try to explain this, let's see the code as it's quite easy to follow:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_snippet.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%% exported functions</span>\n<span class=\"nf\">to_json</span><span class=\"p\">({</span><span class=\"n\">snippet</span><span class=\"p\">,</span> <span class=\"nv\">SnippetData</span><span class=\"p\">})</span> <span class=\"o\">-&gt;</span>\n  <span class=\"n\">to_json_internal</span><span class=\"p\">(</span><span class=\"nv\">SnippetData</span><span class=\"p\">).</span>\n\n<p><span class=\"nf\">from_json</span><span class=\"p\">(</span><span class=\"nv\">SnippetJson</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"n\">from_json_internal</span><span class=\"p\">(</span><span class=\"nv\">SnippetJson</span><span class=\"p\">).</span></p>\n<p><span class=\"c\">%% helper functions used internally.</span>\n<span class=\"nf\">to_json_internal</span><span class=\"p\">(</span><span class=\"nv\">SnippetData</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">csd_json</span><span class=\"p\">:</span><span class=\"n\">to_json</span><span class=\"p\">(</span><span class=\"nv\">SnippetData</span><span class=\"p\">,</span> <span class=\"k\">fun</span> <span class=\"n\">is_string</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">).</span></p>\n<p><span class=\"nf\">from_json_internal</span><span class=\"p\">(</span><span class=\"nv\">SnippetJson</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">snippet</span><span class=\"p\">,</span> <span class=\"nn\">csd_json</span><span class=\"p\">:</span><span class=\"n\">from_json</span><span class=\"p\">(</span><span class=\"nv\">SnippetJson</span><span class=\"p\">,</span> <span class=\"k\">fun</span> <span class=\"n\">is_string</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">)}.</span></p>\n<p><span class=\"nf\">is_string</span><span class=\"p\">(</span><span class=\"n\">title</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">true</span><span class=\"p\">;</span>\n<span class=\"nf\">is_string</span><span class=\"p\">(</span><span class=\"n\">left</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">true</span><span class=\"p\">;</span>\n<span class=\"nf\">is_string</span><span class=\"p\">(</span><span class=\"n\">right</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">true</span><span class=\"p\">;</span>\n<span class=\"nf\">is_string</span><span class=\"p\">(_)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">false</span><span class=\"p\">.</span>\n</pre></div></p>\n<p>As you can see, these are helper functions which call the <code>csd_json</code> functions to serialise/deserialise to/from JSON format. The <code>is_string()</code> function is the one that is used to tell the JSON functionality which properties are strings and which are not. At the moment, all properties defined on the snippet are string properties. Bear in mind that the <code>key</code> property, which is added automatically, is <em>not</em> a string.</p>\n<p>All that is left is to see how <code>csd_riak</code> deals with the underlying Riak connectivity. Prepare to be underwhelmed!</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_riak.erl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%% @spec connect(connection_info()) -&gt; pid()</span>\n<span class=\"c\">%% @doc Create a connection to the specified Riak cluster and</span>\n<span class=\"c\">%%      return the Pid associated with the new connection.</span>\n<span class=\"nf\">connect</span><span class=\"p\">({</span><span class=\"nv\">IP</span><span class=\"p\">,</span> <span class=\"nv\">Port</span><span class=\"p\">})</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"nv\">RiakPid</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nn\">riakc_pb_socket</span><span class=\"p\">:</span><span class=\"n\">start_link</span><span class=\"p\">(</span><span class=\"nv\">IP</span><span class=\"p\">,</span> <span class=\"nv\">Port</span><span class=\"p\">),</span>\n  <span class=\"nv\">RiakPid</span><span class=\"p\">.</span>\n\n<p><span class=\"c\">%% @spec create(binary, binary, json) -&gt; riakc_obj()</span>\n<span class=\"c\">%% @doc Create a new instance of a riak object using the</span>\n<span class=\"c\">%%      parameters given. The riak object can then be</span>\n<span class=\"c\">%%      persisted to a Riak node/cluster. This overload</span>\n<span class=\"c\">%%      assumes that the data passed in is JSON and sets</span>\n<span class=\"c\">%%      the MIME type to &quot;application/json&quot; for you.</span>\n<span class=\"nf\">create</span><span class=\"p\">(</span><span class=\"nv\">Bucket</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">,</span> <span class=\"nv\">JsonData</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"n\">create</span><span class=\"p\">(</span><span class=\"nv\">Bucket</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">,</span> <span class=\"nv\">JsonData</span><span class=\"p\">,</span> <span class=\"s\">&quot;application/json&quot;</span><span class=\"p\">).</span></p>\n<p><span class=\"c\">%% @spec create(binary, binary, term(), string) -&gt; riakc_obj()</span>\n<span class=\"c\">%% @doc Create a new instance of a riak object using the</span>\n<span class=\"c\">%%      parameters given. The riak object can then be</span>\n<span class=\"c\">%%      persisted to a Riak node/cluster. This overload</span>\n<span class=\"c\">%%      takes arbitrary data and requires the user to</span>\n<span class=\"c\">%%      specify the mime type of the data that is being</span>\n<span class=\"c\">%%      stored.</span>\n<span class=\"nf\">create</span><span class=\"p\">(</span><span class=\"nv\">Bucket</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">,</span> <span class=\"nv\">Item</span><span class=\"p\">,</span> <span class=\"nv\">MimeType</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">RiakObj</span> <span class=\"o\">=</span> <span class=\"nn\">riakc_obj</span><span class=\"p\">:</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"nv\">Bucket</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">,</span> <span class=\"nv\">Item</span><span class=\"p\">,</span> <span class=\"nv\">MimeType</span><span class=\"p\">),</span>\n  <span class=\"nv\">RiakObj</span><span class=\"p\">.</span></p>\n<p><span class=\"c\">%% @spec fetch(pid(), binary, binary) -&gt; riakc_obj()</span>\n<span class=\"c\">%% @doc Fetches a riakc object from a Riak node/cluster</span>\n<span class=\"c\">%%      using the connection given.</span>\n<span class=\"nf\">fetch</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">Bucket</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">RiakObj</span> <span class=\"o\">=</span> <span class=\"nn\">riakc_pb_socket</span><span class=\"p\">:</span><span class=\"nb\">get</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">Bucket</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">),</span>\n  <span class=\"nv\">RiakObj</span><span class=\"p\">.</span></p>\n<p><span class=\"c\">%% @spec update(riakc_obj(), term()) -&gt; riakc_obj()</span>\n<span class=\"c\">%% @doc Updates the stored value for a riakc object with</span>\n<span class=\"c\">%%      the new one specified.</span>\n<span class=\"nf\">update</span><span class=\"p\">(</span><span class=\"nv\">RiakObj</span><span class=\"p\">,</span> <span class=\"nv\">NewValue</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">NewRiakObj</span> <span class=\"o\">=</span> <span class=\"nn\">riakc_obj</span><span class=\"p\">:</span><span class=\"n\">update_value</span><span class=\"p\">(</span><span class=\"nv\">RiakObj</span><span class=\"p\">,</span> <span class=\"nv\">NewValue</span><span class=\"p\">),</span>\n  <span class=\"nv\">NewRiakObj</span><span class=\"p\">.</span></p>\n<p><span class=\"c\">%% @spec get_value(riakc_obj()) -&gt; term()</span>\n<span class=\"c\">%% @doc Retrieves the stored value from within the riakc</span>\n<span class=\"c\">%%      object.</span>\n<span class=\"nf\">get_value</span><span class=\"p\">(</span><span class=\"nv\">RiakObj</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">Value</span> <span class=\"o\">=</span> <span class=\"nn\">riakc_obj</span><span class=\"p\">:</span><span class=\"n\">get_value</span><span class=\"p\">(</span><span class=\"nv\">RiakObj</span><span class=\"p\">),</span>\n  <span class=\"nv\">Value</span><span class=\"p\">.</span></p>\n<p><span class=\"c\">%% @spec save(pid(), riakc_obj()) -&gt; {ok, riakc_obj()} | {error | Reason}</span>\n<span class=\"c\">%% @doc Saves the given riak object to the specified Riak node/cluster.</span>\n<span class=\"nf\">save</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">RiakObj</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">Result</span> <span class=\"o\">=</span> <span class=\"nn\">riakc_pb_socket</span><span class=\"p\">:</span><span class=\"nb\">put</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">RiakObj</span><span class=\"p\">),</span>\n  <span class=\"nv\">Result</span><span class=\"p\">.</span></p>\n<p><span class=\"c\">%% @spec new_key() -&gt; key()</span>\n<span class=\"c\">%% @doc Generate an close-to-unique key that can be used to identify</span>\n<span class=\"c\">%%      an object in riak. This implementation is blatantly borrowed</span>\n<span class=\"c\">%%      (purloined) from the wriaki source (thanks basho!)</span>\n<span class=\"nf\">new_key</span><span class=\"p\">()</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{{</span><span class=\"nv\">Yr</span><span class=\"p\">,</span> <span class=\"nv\">Mo</span><span class=\"p\">,</span> <span class=\"nv\">Dy</span><span class=\"p\">},</span> <span class=\"p\">{</span><span class=\"nv\">Hr</span><span class=\"p\">,</span> <span class=\"nv\">Mn</span><span class=\"p\">,</span> <span class=\"nv\">Sc</span><span class=\"p\">}}</span> <span class=\"o\">=</span> <span class=\"nn\">erlang</span><span class=\"p\">:</span><span class=\"n\">universaltime</span><span class=\"p\">(),</span>\n  <span class=\"p\">{_,</span> <span class=\"p\">_,</span> <span class=\"nv\">Now</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"n\">now</span><span class=\"p\">(),</span>\n  <span class=\"n\">new_key</span><span class=\"p\">([</span><span class=\"nv\">Yr</span><span class=\"p\">,</span> <span class=\"nv\">Mo</span><span class=\"p\">,</span> <span class=\"nv\">Dy</span><span class=\"p\">,</span> <span class=\"nv\">Hr</span><span class=\"p\">,</span> <span class=\"nv\">Mn</span><span class=\"p\">,</span> <span class=\"nv\">Sc</span><span class=\"p\">,</span> <span class=\"nb\">node</span><span class=\"p\">(),</span> <span class=\"nv\">Now</span><span class=\"p\">]).</span></p>\n<p><span class=\"c\">%% @spec new_key(list()) -&gt; key()</span>\n<span class=\"c\">%% @doc Generate an close-to-unique key that can be used to identify</span>\n<span class=\"c\">%%      an object in riak using the given list parameter as the stuff</span>\n<span class=\"c\">%%      to hash.</span>\n<span class=\"nf\">new_key</span><span class=\"p\">(</span><span class=\"nv\">List</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">Hash</span> <span class=\"o\">=</span> <span class=\"nn\">erlang</span><span class=\"p\">:</span><span class=\"nb\">phash2</span><span class=\"p\">(</span><span class=\"nv\">List</span><span class=\"p\">),</span>\n  <span class=\"nn\">base64</span><span class=\"p\">:</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"o\">&lt;&lt;</span><span class=\"nv\">Hash</span><span class=\"p\">:</span><span class=\"mi\">32</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">).</span>\n</pre></div></p>\n<p>Hopefully the code in this module is fairly self-explanatory. It's a very simple API to follow which made it very easy to build. So with this in place, let's fire up the application, create a new snippet and see if it lands in the Riak store:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link  ~/blog/csd $ make webstart\n\n... snip ...\n\n<p>=PROGRESS REPORT==== 4-Apr-2011::22:54:55 ===\n         application: csd_web\n          started_at: nonode@nohost</p>\n<p>1&gt; Snippet = csd_snippet:to_snippet(\n1&gt; &quot;Super composition!&quot;,\n1&gt; &quot;(.^) = (.) . (.)&quot;,\n1&gt; &quot;(.^) = fmap <code>fmap</code> fmap&quot;).\n{snippet,[{title,&quot;Super composition!&quot;},\n          {left,&quot;(.^) = (.) . (.)&quot;},\n          {right,&quot;(.^) = fmap <code>fmap</code> fmap&quot;}]}\n2&gt; SavedSnippet = csd_core_server:save_snippet(Snippet).</p>\n<p>PROGRESS REPORT==== 4-Apr-2011::22:57:13 ===\n          supervisor: {local,inet_gethost_native_sup}\n             started: [{pid,&lt;0.103.0&gt;},{mfa,{inet_gethost_native,init,[[]]}}]</p>\n<p>=PROGRESS REPORT==== 4-Apr-2011::22:57:13 ===\n          supervisor: {local,kernel_safe_sup}\n             started: [{pid,&lt;0.102.0&gt;},\n                       {name,inet_gethost_native_sup},\n                       {mfargs,{inet_gethost_native,start_link,[]}},\n                       {restart_type,temporary},\n                       {shutdown,1000},\n                       {child_type,worker}]\n{snippet,[{key,&lt;&lt;&quot;B41kUQ==&quot;&gt;&gt;},\n          {title,&quot;Super composition!&quot;},\n          {left,&quot;(.^) = (.) . (.)&quot;},\n          {right,&quot;(.^) = fmap <code>fmap</code> fmap&quot;}]}\n</pre></div></p>\n<p>As you can see from the above script dump, a new <code>key</code> was generated for us and stored alongside the snippet (it's highlighted in bold). Verifying that the data has persisted is simple. We can hit any of the Riak nodes via its web interface. Let's take a look at <strong>http://localhost:8091/riak/snippet/B41kUQ==</strong> (your URL will have a different key):</p>\n<img src=\"http://buffered.io/uploads/2010/10/localhost-verify-write.png\" />\n\n<p>Great stuff! For more detail, let's see what cURL has to say:</p>\n<div class=\"pygments_murphy\"><pre>oj@spawn-link ~/blog/csd/ $ curl http://localhost:8091/riak/snippet/B41kUQ== -v\n* About to connect() to localhost port 8091 (#0)\n*   Trying ::1... Connection refused\n*   Trying 127.0.0.1... connected\n* Connected to localhost (127.0.0.1) port 8091 (#0)\n&gt; GET /riak/snippet/B41kUQ== HTTP/1.1\n&gt; User-Agent: curl/7.21.0 (x86_64-pc-linux-gnu) libcurl/7.21.0 OpenSSL/0.9.8o zlib/1.2.3.4 libidn/1.18\n&gt; Host: localhost:8091\n&gt; Accept: */*\n&gt; \n&lt; HTTP/1.1 200 OK\n&lt; X-Riak-Vclock: a85hYGBgzGDKBVIsjOy7jmcwJTLmsTJ8tuc7zpcFAA==\n&lt; Vary: Accept-Encoding\n&lt; Server: MochiWeb/1.1 WebMachine/1.7.3 (participate in the frantic)\n&lt; Link: &lt;/riak/snippet&gt;; rel=&quot;up&quot;\n&lt; Last-Modified: Mon, 04 Apr 2011 13:13:23 GMT\n&lt; ETag: &quot;6fw7c5v4IPAsf4B5hMHybc&quot;\n&lt; Date: Mon, 04 Apr 2011 13:13:36 GMT\n&lt; Content-Type: application/json\n&lt; Content-Length: 107\n&lt; \n* Connection #0 to host localhost left intact\n* Closing connection #0\n{&quot;key&quot;:&quot;B41kUQ==&quot;,&quot;title&quot;:&quot;Super composition!&quot;,&quot;left&quot;:&quot;(.^) = (.) . (.)&quot;,&quot;right&quot;:&quot;(.^) = fmap `fmap` fmap&quot;}\n</pre></div>\n\n<p>As you can see, it has not only serialised to JSON properly, but the MIME type has been set correctly as well.</p>\n<p>This is all well and good, but we need our code to be able to read from Riak as well. That's up next.</p>\n<h4 id=\"reading_data_from_riak\">Reading Data from Riak</h4>\n<p>We've already covered off what happens at the bottom level when reading data from Riak (see the above code snippet for more info). To enable this functionality at the top level, we simply need to create a <code>gen_server</code> call, handle it appropriately and expose a function in the <code>csd_snippet</code> module. Let's start at the top level:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_core_server.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%% OTP API function to get a snippet based on the key</span>\n<span class=\"nf\">get_snippet</span><span class=\"p\">(</span><span class=\"nv\">SnippetKey</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nn\">gen_server</span><span class=\"p\">:</span><span class=\"n\">call</span><span class=\"p\">(</span><span class=\"no\">?SERVER</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"n\">get_snippet</span><span class=\"p\">,</span> <span class=\"nv\">SnippetKey</span><span class=\"p\">},</span> <span class=\"n\">infinity</span><span class=\"p\">).</span>\n\n<p><span class=\"c\">%% handle the call and call the functionality from csd_snippet</span>\n<span class=\"nf\">handle_call</span><span class=\"p\">({</span><span class=\"n\">get_snippet</span><span class=\"p\">,</span> <span class=\"nv\">SnippetKey</span><span class=\"p\">},</span> <span class=\"p\">_</span><span class=\"nv\">From</span><span class=\"p\">,</span> <span class=\"nv\">ConnInfo</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">RiakPid</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"nv\">ConnInfo</span><span class=\"p\">),</span>\n  <span class=\"nv\">Snippet</span> <span class=\"o\">=</span> <span class=\"nn\">csd_snippet</span><span class=\"p\">:</span><span class=\"n\">fetch</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">SnippetKey</span><span class=\"p\">),</span>\n  <span class=\"p\">{</span><span class=\"n\">reply</span><span class=\"p\">,</span> <span class=\"nv\">Snippet</span><span class=\"p\">,</span> <span class=\"nv\">ConnInfo</span><span class=\"p\">};</span>\n</pre></div></p>\n<p>This code is a bit of a no-brainer. It's very similar to the writing code, but just a bit simpler. Let's see what the <code>csd_snippet:fetch()</code> function looks like:</p>\n<p><span class=\"filename\">apps/csd_core/src/csd_snippet.erl (part)</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"nf\">fetch</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"nv\">RiakObj</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">fetch</span><span class=\"p\">(</span><span class=\"nv\">RiakPid</span><span class=\"p\">,</span> <span class=\"no\">?BUCKET</span><span class=\"p\">,</span> <span class=\"nv\">Key</span><span class=\"p\">),</span>\n  <span class=\"nv\">SnippetJson</span> <span class=\"o\">=</span> <span class=\"nn\">csd_riak</span><span class=\"p\">:</span><span class=\"n\">get_value</span><span class=\"p\">(</span><span class=\"nv\">RiakObj</span><span class=\"p\">),</span>\n  <span class=\"n\">from_json_internal</span><span class=\"p\">(</span><span class=\"nv\">SnippetJson</span><span class=\"p\">).</span>\n</pre></div>\n\n<p>This code just pulls a Riak object out of the back-end, extracts is value and deserialises it from JSON to our Erlang <code>proplist</code>. Very simple stuff.</p>\n<p>We should be able to build this and, via the Erlang console, verify that it functions:</p>\n<div class=\"pygments_murphy\"><pre>3&gt; Reloading csd_core_server ... ok.\n3&gt; csd_core_server:get_snippet(&lt;&lt;&quot;B41kUQ==&quot;&gt;&gt;).\n{snippet,[{key,&lt;&lt;&quot;B41kUQ==&quot;&gt;&gt;},\n          {title,&quot;Super composition!&quot;},\n          {left,&quot;(.^) = (.) . (.)&quot;},\n          {right,&quot;(.^) = fmap `fmap` fmap&quot;}]}\n</pre></div>\n\n<p>Works like a charm. Now, for the icing on the cake, let's get this rendering in a very simple template in our browser.</p>\n<h3 id=\"end_to_end\">End to End</h3>\n<p>In order to gain access to our data in Riak from the web we need to create a new resource. This resource will respond to any URI of the form <code>/snippet/&amp;lt;key&amp;gt;</code>. We shall call this resource <code>csd_web_snippet_resource</code> and we'll be putting this in our web application. It looks like this:</p>\n<p><span class=\"filename\">apps/csd_web/src/csd_web_snippet_resource.erl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%% @author OJ Reeves &lt;oj@buffered.io&gt;</span>\n<span class=\"c\">%% @copyright 2010 OJ Reeves</span>\n<span class=\"c\">%% @doc Webmachine resource that handles snippet-related actions</span>\n\n<p><span class=\"p\">-</span><span class=\"ni\">module</span><span class=\"p\">(</span><span class=\"n\">csd_web_snippet_resource</span><span class=\"p\">).</span>\n<span class=\"p\">-</span><span class=\"ni\">author</span><span class=\"p\">(</span><span class=\"n\">&#39;OJ Reeves &lt;oj@buffered.io&gt;&#39;</span><span class=\"p\">).</span></p>\n<p><span class=\"p\">-</span><span class=\"ni\">export</span><span class=\"p\">([</span><span class=\"n\">init</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">to_html</span><span class=\"o\">/</span><span class=\"mi\">2</span><span class=\"p\">]).</span></p>\n<p><span class=\"p\">-</span><span class=\"ni\">include_lib</span><span class=\"p\">(</span><span class=\"s\">&quot;webmachine/include/webmachine.hrl&quot;</span><span class=\"p\">).</span></p>\n<p><span class=\"nf\">init</span><span class=\"p\">([])</span> <span class=\"o\">-&gt;</span> <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"n\">undefined</span><span class=\"p\">}.</span></p>\n<p><span class=\"nf\">to_html</span><span class=\"p\">(</span><span class=\"nv\">ReqData</span><span class=\"p\">,</span> <span class=\"nv\">State</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span>\n  <span class=\"nv\">PathInfo</span> <span class=\"o\">=</span> <span class=\"nn\">wrq</span><span class=\"p\">:</span><span class=\"n\">path_info</span><span class=\"p\">(</span><span class=\"nv\">ReqData</span><span class=\"p\">),</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"nv\">SnippetKey</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nn\">dict</span><span class=\"p\">:</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"nv\">PathInfo</span><span class=\"p\">),</span>\n  <span class=\"p\">{</span><span class=\"n\">snippet</span><span class=\"p\">,</span> <span class=\"nv\">SnippetData</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nn\">csd_core_server</span><span class=\"p\">:</span><span class=\"n\">get_snippet</span><span class=\"p\">(</span><span class=\"nb\">list_to_binary</span><span class=\"p\">(</span><span class=\"nv\">SnippetKey</span><span class=\"p\">)),</span>\n  <span class=\"p\">{</span><span class=\"n\">ok</span><span class=\"p\">,</span> <span class=\"nv\">Content</span><span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nn\">snippet_dtl</span><span class=\"p\">:</span><span class=\"n\">render</span><span class=\"p\">(</span><span class=\"nv\">SnippetData</span><span class=\"p\">),</span>\n  <span class=\"p\">{</span><span class=\"nv\">Content</span><span class=\"p\">,</span> <span class=\"nv\">ReqData</span><span class=\"p\">,</span> <span class=\"nv\">State</span><span class=\"p\">}.</span>\n</pre></div></p>\n<p>As you can see, this code calls through to the <code>csd_core_server</code> to extract the data from the back-end. The value that is used as a key for the snippet is one that is pulled from the URI via Webmachine's <code>wrq:path_info()</code> function. This function extracts values from the URI based on the rules in <code>dispatch.conf</code> and provides a <a href=\"http://www.erlang.org/doc/man/dict.html\" title=\"Erlang dict\">dict</a> which can be used to lookup the values.</p>\n<p>The code also uses a new ErlyDTL template called <code>snippet</code>. We'd best add that to the <code>templates</code> folder:</p>\n<p><span class=\"filename\">apps/csd_web/templates/snippet.dtl</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;h1&gt;</span>Snippet View<span class=\"nt\">&lt;/h1&gt;</span>\n    <span class=\"nt\">&lt;h2&gt;</span>{{ title }}<span class=\"nt\">&lt;/h2&gt;</span>\n    <span class=\"nt\">&lt;p&gt;</span>Left: {{ left }}<span class=\"nt\">&lt;/p&gt;</span>\n    <span class=\"nt\">&lt;p&gt;</span>Right: {{ right }}<span class=\"nt\">&lt;/p&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</pre></div>\n\n<p>Finally, we just need to adjust <code>dispatch.conf</code> to include the new route handler so that our code gets called:</p>\n<p><span class=\"filename\">apps/csd_web/priv/dispatch.conf</span></p>\n<div class=\"pygments_murphy\"><pre><span class=\"c\">%%-*- mode: erlang -*-</span>\n<span class=\"p\">{[],</span> <span class=\"n\">csd_web_resource</span><span class=\"p\">,</span> <span class=\"p\">[]}.</span>\n<span class=\"p\">{[</span><span class=\"s\">&quot;snippet&quot;</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">],</span> <span class=\"n\">csd_web_snippet_resource</span><span class=\"p\">,</span> <span class=\"p\">[]}.</span>\n</pre></div>\n\n<p>Note how <code>key</code> is specified alongside <code>\"snippet\"</code>. This means that the path following <code>snippet/</code> in the URI will be associated with the <code>key</code> atom in the <code>dict</code> generated by <code>wrq:path_info()</code>.</p>\n<p>We're ready to rock. Rebuild, then hit the right URL, <strong>http://localhost/snippet/B41kUQ==</strong> (again, your key will be different), and you should get the following:</p>\n<img src=\"http://buffered.io/uploads/2010/10/webmachine-to-riak.png\" />\n\n<h2>Wrapping up</h2>\n<p>Thanks for sticking with me! As you can see there is a little bit of ground-work required if you're interested in producing some form of structure that you can reuse all over your application, but the effort is definitely worth it. Now we have something in place which we can use to store arbitrarily complex <code>proplists</code> into Riak in JSON format, we have the ability to talk to Riak (read and write), and we have a proper application structure in place which we can build on.</p>\n<p>Please note that the mechanism implemented in this post is quite simple and doesn't cover all cases that will be required before the application is complete. In future posts, this implementation will change to support more of those cases, such as dealing with concurrent updates, handling versions, etc.</p>\n<p>Many thanks to those people who took the time out of their busy schedules to review my post before I shared it with the world. Those people shall remain nameless to protect them from any mistakes made in this post (which are solely my own).</p>\n<p>As always, comments and feedback is welcomed and greatly appreciated. As are suggestions on improvements, pitfalls and blatant mistakes :)</p>\n<p><strong>Note:</strong> The code for Part 3 (this post) can be found <a href=\"https://bitbucket.org/OJ/csd/src/55fec468488c\" title=\"Source code for Part 3\">on my Bitbucket account</a>.</p>",
  "isoTimestamp": "2010-10-13T11:31:58.000Z",
  "_id": "2010-10-13T11:31:58.000Z-OJs Rants",
  "site": {
    "feed": "http://buffered.io/feed/index.xml",
    "author": "OJ Reeves",
    "link": "http://buffered.io/"
  },
  "displayDate": "Oct 13 2010"
}